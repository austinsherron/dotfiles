#!/usr/bin/env bash


## constants ###################################################################


## path updates ################################################################

export PATH="/opt/homebrew/opt/postgresql@17/bin:$PATH"
export PATH="/opt/homebrew/opt/libpq/bin:$PATH"

## important paths #############################################################

export WORK_ROOT="${CODE_ROOT}/maybern"

## aliases #####################################################################

### rename

alias hf="helmfile"
alias kc="kubectl"
alias kctx="kubectx"
alias n="neonctl"
alias tf="terraform"
alias tg="terragrunt"

## functions ###################################################################

# gh

function pr() {
    local cmd="${1}"

    case $cmd in
        c|cr|create) gh pr create -a @me ;;
        m|mr|merge) just run-server ;;
        cl|close) gh pr close $(g branch --show-current) ;;
        l|ls|list) gh pr ls --author @me ;;
        n|num) gh pr view --json number | jq -r .number ;;
        *) ulogger error "Unknown command: $cmd" ; return 1 ;;
    esac
}

# just

function j() {
    local cmd="${1}"

    case $cmd in
         gf) just generate-fixtures ;;
         rs) just run-server ;;
         rc) just run-celery ;;
          *) ulogger error "Unknown command: $cmd" ; return 1 ;;
    esac
}

# linear

function lr() {
    local cmd="${1:-ls}"

    case $cmd in
         ls) linear-cli issues list ;;
      start) linear-cli issues develop "$(lr::get_issue_id)" ;;
          *) linear-cli ${@} ;;
    esac
}

function lr::get_issue_id() {
    linear-cli issues list | peco | awk '{print $1}'
}

# slack

function add-slack-mentions() {
    local message="$1"
    local conf_file="$XDG_CONFIG_HOME/slack/users.conf"

    # build sed expression from slack.conf
    local sed_expr
    sed_expr=$(awk -F= '
        /^[^#[:space:]]+=U/ {
            printf "s/@%s/\\<@%s\\>/g;", $1, $2
        }
    ' "$conf_file")

    # apply the expression using sed
    echo "$message" | sed "$sed_expr"
}

function get-slack-channel-id() {
    local channel="${1#[@#]}"   # strip leading @ or # if present
    local id=""

    # look in channels.conf first (public/private channels)
    if [[ -f "$XDG_CONFIG_HOME/slack/channels.conf" ]]; then
        id=$(grep -s "^${channel}=" "$XDG_CONFIG_HOME/slack/channels.conf" | awk -F= '{print $2}')
    fi

    # if not found, look in users.conf (DMs -> user id)
    if [[ -z "$id" && -f "$XDG_CONFIG_HOME/slack/users.conf" ]]; then
        id=$(grep -s "^${channel}=" "$XDG_CONFIG_HOME/slack/users.conf" | awk -F= '{print $2}')
    fi

    echo "$id"
}

function send-slack-message() {
    local channel="${1}"
    local message="${2}"

    [[ "$channel" != \#* ]] && channel="$(get-slack-channel-id "$channel")"
    message="$(add-slack-mentions "$message")"

    local res=$(curl -s -X POST https://slack.com/api/chat.postMessage \
    -H "Authorization: Bearer $SLACK_USER_BOT_TOKEN" \
    -H 'Content-type: application/json' \
    --data "{
        \"channel\":\"${channel}\",
        \"text\":\"${message}\"
    }")

    echo "$res" | jq -r '.ok'
}
